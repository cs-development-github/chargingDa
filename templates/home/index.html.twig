{% extends 'base.html.twig' %}
{% block body %}
<div class="container">
  <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#progressModal">
    Ajouter un client
  </button>

  <div class="modal fade" id="progressModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Information du client</h5>
        </div>
        <div class="modal-body">
          <div class="progress mb-3">
            <div id="progressStep1" class="progress-bar bg-success" style="width: 50%;"></div>
            <div id="progressStep2" class="progress-bar bg-secondary" style="width: 50%;"></div>
          </div>

          {# Stockage du prototype pour éviter le rendu multiple #}
          {% set prototype_intervention = form_widget(interventionForm.interventions.vars.prototype) %}

          <form id="multiStepForm" method="post" action="{{ path('app_submit_form') }}">
            {{ form_start(clientForm, {'attr': {'id': 'multiStepForm'}}) }}

            <div class="form-step mb-4" id="step1">
              {{ form_widget(clientForm) }}
            </div>

            <div class="form-step d-none mb-4" id="step2">
              {{ form_widget(interventionForm) }}

              <div id="interventionContainer" data-prototype="{{ prototype_intervention|e('html_attr') }}">
                {% for intervention in interventionForm.interventions %}
                <div class="intervention-item">
                  {{ form_widget(intervention) }}
                  <button type="button" class="btn btn-danger btn-sm remove-intervention">Supprimer</button>
                </div>
                {% endfor %}
              </div>
              <button type="button" class="btn btn-primary btn-sm" id="addIntervention">+ Ajouter une borne</button>
            </div>

            <div class="modal-footer">
              <button type="button" id="prevBtn" class="btn btn-secondary d-none">Précédent</button>
              <button type="button" id="nextBtn" class="btn btn-primary">Suivant</button>
              <button type="submit" id="submitBtn" class="btn btn-success d-none">Envoyer</button>
            </div>

            {{ form_end(clientForm) }}
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentStep = 1;
  const totalSteps = 2;

  function updateStep() {
    document.querySelectorAll(".form-step").forEach(step => step.classList.add("d-none"));
    document.getElementById("step" + currentStep).classList.remove("d-none");

    document.getElementById("progressStep1").classList.add("bg-success");
    document.getElementById("progressStep2").classList.toggle("bg-success", currentStep === 2);

    document.getElementById("modalTitle").textContent =
      currentStep === 1 ? "Information du client" : "Information de l'installation";

    document.getElementById("prevBtn").classList.toggle("d-none", currentStep === 1);
    document.getElementById("nextBtn").classList.toggle("d-none", currentStep === totalSteps);
    document.getElementById("submitBtn").classList.toggle("d-none", currentStep !== totalSteps);
  }

  document.getElementById("nextBtn").addEventListener("click", () => {
    if (currentStep < totalSteps) {
      currentStep++;
      updateStep();
    }
  });

  document.getElementById("prevBtn").addEventListener("click", () => {
    if (currentStep > 1) {
      currentStep--;
      updateStep();
    }
  });

  document.getElementById("submitBtn").addEventListener("click", function (event) {
    event.preventDefault(); 
    let form = document.getElementById("multiStepForm");
    if (!form) return;
    document.getElementById("submitBtn").disabled = true;
    form.submit();
  });

  document.getElementById("multiStepForm").addEventListener("submit", function (event) {
    event.preventDefault();
    setTimeout(() => {
      this.submit();
    }, 1000);
  });

  document.addEventListener("DOMContentLoaded", function () {
    let addInterventionButton = document.getElementById("addIntervention");
    let interventionContainer = document.getElementById("interventionContainer");

    if (!interventionContainer.dataset.prototype) {
      console.error("data-prototype is missing on #interventionContainer");
      return;
    }

    let prototype = interventionContainer.dataset.prototype;

    addInterventionButton.addEventListener("click", function () {
      let newIndex = interventionContainer.children.length;
      let newElement = document.createElement("div");
      newElement.innerHTML = prototype.replace(/__name__/g, newIndex);
      newElement.classList.add("intervention-item");

      let removeButton = document.createElement("button");
      removeButton.type = "button";
      removeButton.className = "btn btn-danger btn-sm remove-intervention";
      removeButton.textContent = "Supprimer";
      removeButton.addEventListener("click", function () {
        newElement.remove();
      });

      newElement.appendChild(removeButton);
      interventionContainer.appendChild(newElement);
    });

    document.addEventListener("click", function (event) {
      if (event.target.classList.contains("remove-intervention")) {
        event.target.closest(".intervention-item").remove();
      }
    });
  });
</script>
{% endblock %}